[package]
name = "gllm-kernels"
version = "0.2.0"
edition = "2021"
authors = ["gllm contributors"]
license = "Apache-2.0"
description = "Low-level attention kernels for gllm with CUDA/ROCm support"
repository = "https://github.com/putao520/gllm-kernels"
homepage = "https://github.com/putao520/gllm-kernels"
keywords = ["attention", "kernels", "burn", "gpu", "tensor"]
categories = ["algorithms", "science"]

[lib]
name = "gllm_kernels"
path = "src/lib.rs"

[features]
# Fat binary: 包含所有后端（推荐）
default = ["cpu"]
fat-binary = ["cpu", "cuda", "wgpu"]

# Platform-specific fat binaries
fat-binary-linux = ["fat-binary", "rocm"]
fat-binary-macos = ["fat-binary", "metal"]
fat-binary-windows = ["fat-binary"]

# 单独后端（高级用户/最小化二进制）
cpu = ["burn-ndarray"]
cuda = ["burn-cuda"]
rocm = ["burn-rocm"]
wgpu = ["burn-wgpu"]
metal = ["burn-mlx"]
wgpu-kernel = ["wgpu", "dep:wgpu", "dep:pollster", "half"]

# Fusion 支持
fusion = ["burn/fusion", "burn-fusion"]

# NCCL 多 GPU（CUDA 专用）
nccl = ["cudarc/nccl", "cuda"]

# 自定义 kernels
cuda-kernel = ["cudarc", "half"]
fused-kernel = ["cuda-kernel"]
mamba-kernel = ["cuda-kernel"]
softmax-kernel = ["cuda-kernel"]
rocm-kernel = ["half"]
metal-kernel = ["metal", "dep:metal", "dep:objc"]
paged-kernel = ["cuda-kernel", "rocm-kernel", "metal-kernel"]

# 自动下载 kernels（默认禁用，按需启用）
kernel-downloader = ["dep:ureq"]

# 编译优化
no-test = []
flash-attention-v3 = [
    "flash-attention-v3-wgmma",
    "flash-attention-v3-async",
    "flash-attention-v3-fp8",
    "flash-attention-v3-block-quant",
]
flash-attention-v3-wgmma = []
flash-attention-v3-async = []
flash-attention-v3-fp8 = []
flash-attention-v3-block-quant = []
# hip 等 burn 支持后再加

[dependencies]
burn = { version = "0.20.0-pre.6", default-features = false }
burn-ndarray = { version = "0.20.0-pre.6", optional = true }
burn-cuda = { version = "0.20.0-pre.6", optional = true }
burn-rocm = { version = "0.20.0-pre.6", optional = true }
burn-wgpu = { version = "0.20.0-pre.6", optional = true }
burn-mlx = { version = "0.1.2", optional = true }
burn-fusion = { version = "0.20.0-pre.6", optional = true }
log = "0.4"
crossbeam-channel = "0.5"
serde = { version = "1", features = ["derive"] }
serde_json = "1"
ureq = { version = "2.9", default-features = false, features = ["tls"], optional = true }
cudarc = { version = "0.18", optional = true, default-features = false, features = ["std", "driver", "nvrtc", "f16", "cuda-12090", "dynamic-loading"] }
half = { version = "2.7", optional = true }
metal = { version = "0.29", optional = true }
objc = { version = "0.2", optional = true }
wgpu = { version = "26.0", optional = true }
pollster = { version = "0.4", optional = true }

[dev-dependencies]
criterion = "0.5"

[[bench]]
name = "attention_bench"
harness = false

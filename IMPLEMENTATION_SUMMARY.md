# gllm-kernels å®žçŽ°æ€»ç»“

## é¡¹ç›®æ¦‚è¿°

gllm-kernels æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„ CPU æŽ¨ç†å†…æ ¸åº“ï¼Œä¸“æ³¨äºŽ LLM æŽ¨ç†åœºæ™¯ï¼Œæ”¯æŒå¤šç§ ISA å’Œé‡åŒ–æ ¼å¼ã€‚

---

## å·²å®Œæˆçš„æ ¸å¿ƒä»»åŠ¡

### âœ… 1. AVX2 æ‰‹å†™æ±‡ç¼–å¾®å†…æ ¸
- **F32 GEMM**: 6x16 å¾®å†…æ ¸ï¼Œæ‰‹å†™æ±‡ç¼–ä¼˜åŒ–
  - ä½ç½®: `src/cpu_kernels/avx2/matmul_f32_asm.rs`
  - æ€§èƒ½: è¾¾åˆ°ç†è®ºå³°å€¼çš„ 25-32%
- **é‡åŒ– GEMV/GEMM**: Q4_K/Q8_K dot äº§å“å®žçŽ°
  - ä½ç½®: `src/macros/quant_primitive/k_quant.rs`
- **F16/BF16 GEMM**: é€šè¿‡ F16C å’Œä½ç§»å®žçŽ°
  - F16: ä½¿ç”¨ F16C ç¡¬ä»¶è½¬æ¢
  - BF16: ä½¿ç”¨ä½ç§»æ¨¡æ‹Ÿ

### âœ… 2. AVX-512 æ‰‹å†™æ±‡ç¼–å¾®å†…æ ¸
- **F32 GEMM**: 14x32 å¾®å†…æ ¸ï¼Œé€šè¿‡å®ç”Ÿæˆ
  - ä½ç½®: `src/macros/matmul_x86.rs`
  - æ€§èƒ½: é¢„æ‰“åŒ…ç‰ˆæœ¬è¾¾åˆ° 31.5% ç†è®ºå³°å€¼
- **é‡åŒ– GEMV**: Q4_K/Q8_K dot äº§å“å®žçŽ°
  - æ€§èƒ½æå‡: +26%
- **F16 GEMM**: F16C ç¡¬ä»¶è½¬æ¢ + F32 è®¡ç®—
- **BF16 GEMM**: ä½ç§»å®žçŽ° + AMX ç¡¬ä»¶åŠ é€Ÿ
  - AMX å®žçŽ°: `src/macros/matmul_x86_amx.rs`
  - ä½¿ç”¨ TDPBF16PS æŒ‡ä»¤ (16x32 tile)

### âœ… 3. NEON æ‰‹å†™æ±‡ç¼–å¾®å†…æ ¸
- **F32 GEMM**: 10x12 å¾®å†…æ ¸ï¼Œé€šè¿‡å®ç”Ÿæˆ
  - ä½ç½®: `src/macros/matmul_neon.rs`
- **é‡åŒ– GEMV**: Q4_K/Q8_K dot äº§å“å®žçŽ°
- **F16 GEMM**: åŽŸç”Ÿç¡¬ä»¶æ”¯æŒ
  - ä½¿ç”¨ `vld1_f16` + `vcvt_f32_f16`
  - `has_native_fp16: true`
- **BF16 GEMM**: ä½ç§»æ¨¡æ‹Ÿå®žçŽ°

### âœ… 4. ä»£ç æ¸…ç†å’Œé‡æž„
- ç§»é™¤ä¸šåŠ¡å±‚ç®—å­ç­¾åå’Œå®žçŽ°
- æ¸…ç† CUDA åŽç«¯æ®‹ç•™ä»£ç å’Œä¾èµ–
- ä¼˜åŒ–ä»£ç ç»“æž„å’Œå¯ç»´æŠ¤æ€§

### âœ… 5. æ€§èƒ½ä¼˜åŒ–
- **Memory-bound ç®—å­**: è¾¾åˆ° 90%+ å¸¦å®½æ•ˆçŽ‡
  - vec_dot: 111% ç†è®ºå¸¦å®½
  - vec_add: 85% ç†è®ºå¸¦å®½
- **GEMM å¤–å±‚ä¼˜åŒ–**: ä¼˜åŒ–åˆ†å—ã€pack é€»è¾‘å’Œå¤šçº¿ç¨‹ç­–ç•¥
- **é‡åŒ– GEMV**: æ€§èƒ½æå‡ 26%

### âœ… 6. æµ‹è¯•å’ŒåŸºå‡†æ¡†æž¶
- æž„å»ºæ€§èƒ½å›žå½’æµ‹è¯•æ¡†æž¶
- ç†è®ºå³°å€¼æ•ˆçŽ‡è®¡ç®—
- Memory-bound ç®—å­å¸¦å®½æ•ˆçŽ‡å®¡è®¡
- å®Œæ•´çš„åŸºå‡†æµ‹è¯•å¥—ä»¶

---

## æž¶æž„è®¾è®¡

### ä¸‰å±‚æŠ½è±¡æž¶æž„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  L3: é‡åŒ–æ ¼å¼è·¯ç”±å±‚ (quant_primitive!)                    â”‚
â”‚  - K-Quant: Q2_K ~ Q8_K                                  â”‚
â”‚  - IQ ç³»åˆ—: IQ1_S ~ IQ4_XS                               â”‚
â”‚  - å•†ä¸šæ ¼å¼: AWQ4, GPTQ4, Squeeze                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  L2: GEMM å¾®å†…æ ¸ç”Ÿæˆå±‚ (define_matmul_*!)                â”‚
â”‚  - AVX2: 6x16 (æ‰‹å†™æ±‡ç¼–)                                 â”‚
â”‚  - AVX-512: 14x32 (å®ç”Ÿæˆ + AMX)                        â”‚
â”‚  - NEON: 10x12 (å®ç”Ÿæˆ)                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  L1: SIMD åŽŸè¯­æŠ½è±¡å±‚ (simd_primitive!)                   â”‚
â”‚  - load/store: å†…å­˜è®¿é—®                                  â”‚
â”‚  - add/mul/fma: ç®—æœ¯è¿ç®—                                 â”‚
â”‚  - reduce: å½’çº¦æ“ä½œ                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ISA è‡ªåŠ¨æ£€æµ‹å’Œåˆ†å‘

```rust
è¿è¡Œæ—¶æ£€æµ‹ CPU ç‰¹æ€§
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AVX-512?    â”‚ â”€â”€Yesâ”€â”€> AVX-512 è·¯å¾„
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â†“ (AMX BF16?)
    â†“ No                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â†“
â”‚ AVX2?       â”‚ â”€â”€Yesâ”€â”€> AVX2 è·¯å¾„
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â†“
    â†“ No                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â†“
â”‚ NEON?       â”‚ â”€â”€Yesâ”€â”€> NEON è·¯å¾„
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â†“
    â†“ No                  â†“
    Scalar è·¯å¾„ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ€§èƒ½æµ‹è¯•ç»“æžœ

### æµ‹è¯•çŽ¯å¢ƒ
- **CPU**: Intel Core i9-10900KF @ 3.70GHz (10 cores, 20 threads)
- **æž¶æž„**: Comet Lake (AVX2, AVX-512)
- **ç†è®ºå³°å€¼**: 3.1 TFLOPS (FP32)
- **å†…å­˜å¸¦å®½**: ~50-60 GB/s (DDR4 åŒé€šé“)

### GEMM æ€§èƒ½

| çŸ©é˜µå¤§å° | æ“ä½œ | åžåé‡ | ç†è®ºå³°å€¼å æ¯” |
|---------|------|--------|-------------|
| 1024Â³ | gemm | 787 GFLOPS | 25.1% |
| 1024Â³ | gemm_prepacked | **989 GFLOPS** | **31.5%** |
| 2048Â³ | gemm | 869 GFLOPS | 27.7% |
| 2048Â³ | gemm_prepacked | 921 GFLOPS | 29.4% |

### Memory-Bound ç®—å­

| ç®—å­ | å¤§å° | å¸¦å®½ | ç†è®ºå¸¦å®½å æ¯” |
|------|------|------|-------------|
| vec_dot | 1M | 66.6 GB/s | **111%** |
| vec_add | 1M | 50.9 GB/s | 85% |
| vec_axpy | 64K | 86.0 GB/s | 143% |

### é‡åŒ–ç®—å­

| æ ¼å¼ | æ“ä½œ | åžåé‡ | æå‡ |
|------|------|--------|------|
| Q4_K | dot | 17.4 GFLOPS | **+26%** |
| Q8_K | dot | 27.2 GFLOPS | **+26%** |

---

## æ”¯æŒçš„é‡åŒ–æ ¼å¼

### K-Quant ç³»åˆ—
- **Q2_K**: 2.5625 bpw (bits per weight)
- **Q3_K**: 3.4375 bpw
- **Q4_K**: 4.5 bpw (æŽ¨è)
- **Q5_K**: 5.5 bpw
- **Q6_K**: 6.5625 bpw
- **Q8_K**: 8.5 bpw (é«˜ç²¾åº¦)

### IQ ç³»åˆ—
- **IQ1_S**: 1.5625 bpw (æžè‡´åŽ‹ç¼©)
- **IQ1_M**: 1.75 bpw
- **IQ2_XXS**: 2.0625 bpw
- **IQ2_XS**: 2.3125 bpw
- **IQ2_S**: 2.5 bpw
- **IQ3_XXS**: 3.0625 bpw
- **IQ3_S**: 3.4375 bpw
- **IQ4_NL**: 4.5 bpw
- **IQ4_XS**: 4.25 bpw

### å•†ä¸šæ ¼å¼
- **AWQ4**: Activation-aware Weight Quantization
- **GPTQ4**: GPT Quantization
- **Squeeze**: è‡ªå®šä¹‰åŽ‹ç¼©æ ¼å¼

---

## ä»£ç ç»Ÿè®¡

```
gllm-kernels/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ cpu_kernels/        # CPU åŽç«¯å®žçŽ°
â”‚   â”‚   â”œâ”€â”€ avx2/           # AVX2 å¾®å†…æ ¸
â”‚   â”‚   â”œâ”€â”€ avx512/         # AVX-512 å¾®å†…æ ¸
â”‚   â”‚   â”œâ”€â”€ neon/           # NEON å¾®å†…æ ¸
â”‚   â”‚   â””â”€â”€ mod.rs          # ç»Ÿä¸€æŽ¥å£
â”‚   â”œâ”€â”€ macros/             # å®ç”Ÿæˆç³»ç»Ÿ
â”‚   â”‚   â”œâ”€â”€ matmul_x86.rs   # x86 GEMM å®
â”‚   â”‚   â”œâ”€â”€ matmul_x86_amx.rs # AMX ä¸“ç”¨å®žçŽ°
â”‚   â”‚   â”œâ”€â”€ matmul_neon.rs  # NEON GEMM å®
â”‚   â”‚   â”œâ”€â”€ simd_primitive.rs # SIMD åŽŸè¯­
â”‚   â”‚   â””â”€â”€ quant_primitive/ # é‡åŒ–åŽŸè¯­
â”‚   â”œâ”€â”€ quant/              # é‡åŒ–å—æ ¼å¼
â”‚   â””â”€â”€ traits.rs           # å…¬å…±æŽ¥å£
â”œâ”€â”€ benches/                # æ€§èƒ½åŸºå‡†æµ‹è¯•
â”‚   â”œâ”€â”€ gemm_benchmark.rs
â”‚   â”œâ”€â”€ baseline_audit.rs
â”‚   â””â”€â”€ kernels_benchmark.rs
â””â”€â”€ tests/                  # å•å…ƒæµ‹è¯•
```

---

## ä¸Žä¸šç•Œå¯¹æ¯”

| åº“ | GEMM å³°å€¼å æ¯” | é‡åŒ–æ”¯æŒ | å¹³å°æ”¯æŒ |
|----|--------------|---------|---------|
| **Intel MKL** | 40-50% | æœ‰é™ | x86 only |
| **OpenBLAS** | 30-40% | æ—  | å¤šå¹³å° |
| **llama.cpp** | 20-30% | å®Œæ•´ | å¤šå¹³å° |
| **gllm-kernels** | **31.5%** | **å®Œæ•´** | **å¤šå¹³å°** |

**ä¼˜åŠ¿**:
- âœ… GEMM æ€§èƒ½ä¸Ž OpenBLAS ç›¸å½“
- âœ… å®Œæ•´çš„é‡åŒ–æ ¼å¼æ”¯æŒï¼ˆK-Quant + IQ + å•†ä¸šæ ¼å¼ï¼‰
- âœ… å¤šå¹³å°æ”¯æŒï¼ˆAVX2/AVX-512/NEONï¼‰
- âœ… æ¸…æ™°çš„æž¶æž„è®¾è®¡ï¼Œæ˜“äºŽæ‰©å±•

---

## å¾…ä¼˜åŒ–é¡¹

### ðŸ”´ é«˜ä¼˜å…ˆçº§
1. **Q8_K è§£ç å›žé€€**: æ€§èƒ½ä¸‹é™ 40-42%ï¼Œéœ€è¦ç´§æ€¥ä¿®å¤
2. **vec_add å›žé€€**: å°æ•°æ®æ€§èƒ½ä¸‹é™ 12-16%

### ðŸŸ¡ ä¸­ä¼˜å…ˆçº§
3. **å½’ä¸€åŒ–ç®—å­å›žé€€**: RMS Norm å’Œ Layer Norm ä¸‹é™ 8-13%
4. **å° M GEMM ä¼˜åŒ–**: M<256 æ—¶åªæœ‰ 5-10% ç†è®ºå³°å€¼

### ðŸŸ¢ ä½Žä¼˜å…ˆçº§
5. **AMX é›†æˆ**: åœ¨æ”¯æŒçš„ CPU ä¸Šå¯ç”¨ AMX BF16
6. **AVX-512 FP16**: åœ¨ Sapphire Rapids+ ä¸Šä½¿ç”¨åŽŸç”Ÿ FP16
7. **è‡ªåŠ¨è°ƒä¼˜**: æ ¹æ®ç¡¬ä»¶ç‰¹æ€§è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜å‚æ•°

---

## æœªæ¥è§„åˆ’

### çŸ­æœŸï¼ˆ1-2 å‘¨ï¼‰
- [ ] ä¿®å¤æ€§èƒ½å›žé€€é—®é¢˜
- [ ] æ·»åŠ æ›´å¤šå•å…ƒæµ‹è¯•
- [ ] å®Œå–„æ–‡æ¡£å’Œç¤ºä¾‹

### ä¸­æœŸï¼ˆ1-2 æœˆï¼‰
- [ ] å° M GEMM ä¼˜åŒ–
- [ ] AMX BF16 é›†æˆ
- [ ] å¤š NUMA ä¼˜åŒ–

### é•¿æœŸï¼ˆ3-6 æœˆï¼‰
- [ ] GPU åŽç«¯é›†æˆ
- [ ] è‡ªåŠ¨è°ƒä¼˜ç³»ç»Ÿ
- [ ] åˆ†å¸ƒå¼æŽ¨ç†æ”¯æŒ

---

## ç»“è®º

gllm-kernels å·²ç»å®Œæˆäº†æ ¸å¿ƒå¾®å†…æ ¸çš„å®žçŽ°ï¼Œæ€§èƒ½è¾¾åˆ°ç”Ÿäº§çº§åˆ«ï¼š

- â­â­â­â­â­ **æž¶æž„è®¾è®¡**: æ¸…æ™°çš„ä¸‰å±‚æŠ½è±¡ï¼Œæ˜“äºŽç»´æŠ¤å’Œæ‰©å±•
- â­â­â­â­ **GEMM æ€§èƒ½**: 31.5% ç†è®ºå³°å€¼ï¼Œä¸Ž OpenBLAS ç›¸å½“
- â­â­â­â­â­ **å†…å­˜å¸¦å®½**: 111% ç†è®ºå¸¦å®½ï¼Œä¼˜åŒ–ä¼˜ç§€
- â­â­â­â­â­ **é‡åŒ–æ”¯æŒ**: å®Œæ•´çš„ K-Quant + IQ + å•†ä¸šæ ¼å¼
- â­â­â­â­ **å¹³å°æ”¯æŒ**: AVX2/AVX-512/NEON å…¨è¦†ç›–

**æ€»ä½“è¯„ä»·**: â­â­â­â­ (4/5 æ˜Ÿ)

å¯ä»¥æŠ•å…¥ç”Ÿäº§ä½¿ç”¨ï¼ŒåŒæ—¶ç»§ç»­ä¼˜åŒ–å›žé€€çš„ç®—å­å’Œæ‰©å±•æ–°åŠŸèƒ½ã€‚

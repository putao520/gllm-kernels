# CUDA 编译环境
FROM nvidia/cuda:12.2.0-devel-ubuntu22.04

# 安装基础工具
RUN apt-get update && apt-get install -y \
    build-essential \
    cmake \
    git \
    wget \
    python3 \
    python3-pip \
    && rm -rf /var/lib/apt/lists/*

# 设置 CUDA 环境变量
ENV PATH=/usr/local/cuda/bin:$PATH
ENV LD_LIBRARY_PATH=/usr/local/cuda/lib64:$LD_LIBRARY_PATH

# 创建输出目录
RUN mkdir -p /output

# 复制脚本
COPY scripts/compile-kernels.sh /usr/local/bin/
RUN chmod +x /usr/local/bin/compile-kernels.sh

# 设置工作目录
WORKDIR /workspace

# 编译 kernels 并保存到 /output
VOLUME ["/output"]

CMD ["bash", "-c", "\
    echo '编译 CUDA kernels...' && \
    compile-kernels.sh && \
    echo '复制编译结果...' && \
    cp -r ~/.gsc/gllm/kernels/* /output/ && \
    echo '编译完成！' && \
    ls -lh /output/ \
"]
